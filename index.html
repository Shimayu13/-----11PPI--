<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>心拍周期（PPI）2方式解析Webアプリ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* --- 略: 先ほどまでのCSSと同様 --- */
    body {font-family:'Segoe UI','Hiragino Sans','Meiryo',sans-serif;background:#f5f7fb;color:#222;margin:0;padding:0;}
    .container{max-width:700px;margin:40px auto 0 auto;background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(70,120,200,0.08),0 1.5px 5px rgba(60,90,150,0.04);padding:32px 28px 36px 28px;}
    h1{text-align:center;font-size:1.7em;color:#2562ad;margin-bottom:16px;letter-spacing:0.01em;}
    p{text-align:center;color:#444;font-size:1.08em;}
    #excelFile{display:block;margin:22px auto 0 auto;padding:10px 20px;border:1px solid #b9c6d8;border-radius:8px;background:#f4f8fc;cursor:pointer;transition:border 0.2s;font-size:1em;}
    #excelFile:focus{outline:none;border-color:#2562ad;}
    #output{margin-top:34px;min-height:50px;}
    table{border-collapse:separate;border-spacing:0;width:100%;margin-top:0.5em;box-shadow:0 2px 8px rgba(70,120,200,0.07);background:#f9fbfe;border-radius:12px;overflow:hidden;}
    th,td{padding:10px 12px;border-bottom:1px solid #e3e9f0;font-size:1em;text-align:right;}
    th{background:#e7f0fb;color:#2562ad;font-weight:600;border-top:none;text-align:center;}
    tr:last-child td{border-bottom:none;}
    .summary{margin-top:26px;background:#f1f8ff;border-radius:10px;padding:18px 22px;font-size:1.12em;box-shadow:0 2px 8px rgba(120,170,230,0.07);color:#2260b1;font-weight:500;letter-spacing:0.02em;}
    .error{color:#d62828;background:#fff3f3;border:1px solid #f5c2c2;padding:16px 20px;border-radius:10px;margin-top:18px;text-align:center;font-weight:500;font-size:1.13em;}
    .chart-area{margin-top:38px;background:#f7fbfd;border-radius:15px;box-shadow:0 2px 7px rgba(90,150,220,0.09);padding:20px 14px 28px 14px;width:100%;overflow-x:auto;}
    .chart-area-inner{width:2000px;min-width:430px;margin:0 auto;}
    .chart-area canvas{width:2000px !important;height:300px !important;background:#fff;border-radius:8px;}
    @media (max-width:750px){
      .container{max-width:97vw;padding:8vw 2vw 11vw 2vw;}
      table,th,td{font-size:0.97em;}
      h1{font-size:1.15em;}
      .chart-area-inner,.chart-area canvas{width:700px !important;min-width:250px !important;height:230px !important;}
    }
    .result-method {
      margin-top: 30px;
      padding: 18px 12px;
      background: #f4f8ff;
      border-radius: 13px;
      box-shadow: 0 1.5px 5px rgba(60,90,150,0.05);
      margin-bottom: 28px;
    }
    .result-method h2 {
      color: #2562ad;
      font-size: 1.15em;
      margin-bottom: 12px;
      margin-top: 0;
      text-align: left;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>心拍周期（PPI）<br>2方式解析Webアプリ</h1>
    <p>Excelファイル（1列：アンプリチュードのみ）をアップロードしてください。</p>
    <input type="file" id="excelFile" accept=".xlsx, .xls"/>
    <div class="chart-area" style="display:none">
      <h3 style="text-align:center;color:#2562ad;font-size:1.05em;font-weight:600;margin:10px 0 18px 0;">アンプリチュード推移グラフ</h3>
      <div class="chart-area-inner">
        <canvas id="ampChart"></canvas>
      </div>
    </div>
    <div id="output"></div>
  </div>
  <script>
    const fs = 409.6;
    let ampChart = null;

    // 方式A: minDistanceメイン（運動後向け）
    function findPeaksDistance(data, minDistance) {
      const peaks = [];
      let lastPeak = -minDistance;
      for (let i = 1; i < data.length - 1; i++) {
        if (data[i] > data[i-1] && data[i] > data[i+1]) {
          if (i - lastPeak >= minDistance) {
            peaks.push(i);
            lastPeak = i;
          }
        }
      }
      return peaks;
    }
    // 方式B: プロミネンスメイン（運動前向け）
    function findPeaksProminence(data, minDistance, minProminence) {
      const peaks = [];
      let lastPeak = -minDistance;
      for (let i = 1; i < data.length - 1; i++) {
        const prominence = Math.min(data[i] - data[i-1], data[i] - data[i+1]);
        if (data[i] > data[i-1] && data[i] > data[i+1] && prominence > minProminence) {
          if (i - lastPeak >= minDistance) {
            peaks.push(i);
            lastPeak = i;
          }
        }
      }
      return peaks;
    }
    function stddev(arr) {
      const mean = arr.reduce((a,b)=>a+b,0) / arr.length;
      return Math.sqrt(arr.reduce((a,b)=>a+(b-mean)**2,0)/(arr.length-1));
    }

    document.getElementById('excelFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        const data = new Uint8Array(ev.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const raw = XLSX.utils.sheet_to_json(sheet, {header:1});
        const amplitude = raw.flat().filter(x => typeof x === 'number');
        const output = document.getElementById('output');
        const chartArea = document.querySelector('.chart-area');
        if (amplitude.length < 50) {
          output.innerHTML = "<div class='error'>データが少なすぎます。もっと長い記録をアップロードしてください。</div>";
          chartArea.style.display = "none";
          return;
        }
        // プロミネンス等パラメータ推定
        const ampStd = stddev(amplitude);
        const ampMax = Math.max(...amplitude);
        const ampMin = Math.min(...amplitude);
        const ampRange = ampMax - ampMin;
        const minProminence = Math.max(ampRange * 0.12, ampStd * 0.7);

        // minDistance推定（運動後想定: 最小0.35秒, 運動前: 最大2.5秒）
        const minDistA = Math.floor(fs * 0.35);
        const minDistB = Math.floor(fs * 0.40);

        // --- 両方式でピーク検出 ---
        const peaksA = findPeaksDistance(amplitude, minDistA);
        const peaksB = findPeaksProminence(amplitude, minDistB, minProminence);

        // --- PPI算出 ---
        function calcPPIs(peaks) {
          const ppis = [];
          for (let i = 1; i < peaks.length; i++) {
            ppis.push((peaks[i] - peaks[i-1]) / fs);
          }
          // 両方式で同じ範囲（0.35～2.5s）で外れ値除去
          return ppis.filter(ppi => ppi > 0.35 && ppi < 2.5);
        }
        const validPpisA = calcPPIs(peaksA);
        const validPpisB = calcPPIs(peaksB);

        const meanPPIA = validPpisA.length > 0 ? (validPpisA.reduce((a,b)=>a+b,0)/validPpisA.length) : 0;
        const stdPPIA = validPpisA.length > 1 ? Math.sqrt(validPpisA.reduce((a,b)=>a+(b-meanPPIA)**2,0)/(validPpisA.length-1)) : 0;
        const meanPPIB = validPpisB.length > 0 ? (validPpisB.reduce((a,b)=>a+b,0)/validPpisB.length) : 0;
        const stdPPIB = validPpisB.length > 1 ? Math.sqrt(validPpisB.reduce((a,b)=>a+(b-meanPPIB)**2,0)/(validPpisB.length-1)) : 0;

        // グラフ横幅調整
        let displayWidth = 2000;
        if (amplitude.length > 3000) {
          displayWidth = Math.max(2000, Math.ceil(amplitude.length * 0.65));
        } else if (amplitude.length > 900) {
          displayWidth = Math.max(1200, Math.ceil(amplitude.length * 0.8));
        }
        document.querySelector('.chart-area-inner').style.width = displayWidth + "px";
        document.getElementById('ampChart').width = displayWidth;
        document.getElementById('ampChart').height = 300;

        // 時刻配列
        const times = amplitude.map((_,i)=> i/fs);
        if (ampChart) ampChart.destroy();
        chartArea.style.display = "";

        // ピーク点はA・B両方描画（A赤、B緑）
        const peaksASet = new Set(peaksA);
        const peaksBSet = new Set(peaksB);
        ampChart = new Chart(document.getElementById('ampChart').getContext('2d'), {
          type: 'line',
          data: {
            labels: times,
            datasets: [
              {
                label: 'Amplitude',
                data: amplitude,
                pointRadius: 0,
                fill: false,
                borderColor: "#337ab7",
                backgroundColor: "#337ab7",
                borderWidth: 1.4,
                tension: 0.07,
                yAxisID: 'y',
              },
              {
                label: 'Peak A',
                data: times.map((t, i) => peaksASet.has(i) ? amplitude[i] : null),
                pointRadius: 4,
                pointBackgroundColor: "red",
                type: "scatter",
                showLine: false,
                yAxisID: 'y',
                borderWidth: 0,
              },
              {
                label: 'Peak B',
                data: times.map((t, i) => (peaksBSet.has(i) && !peaksASet.has(i)) ? amplitude[i] : null),
                pointRadius: 4,
                pointBackgroundColor: "limegreen",
                type: "scatter",
                showLine: false,
                yAxisID: 'y',
                borderWidth: 0,
              }
            ]
          },
          options: {
            plugins: {
              legend: { display: false }
            },
            scales: {
              x: {
                title: { display: true, text: "時刻 [秒]", font: { size: 15 } },
                ticks: {
                  font: { size: 13 },
                  callback: function(value, index, ticks) {
                    let stepSize = 1;
                    if (times.length > 40) stepSize = Math.ceil(times.length / 30);
                    return index % stepSize === 0 ? this.getLabelForValue(value) : '';
                  },
                  maxRotation: 30,
                  minRotation: 0,
                  autoSkip: false,
                },
                grid: {
                  display: true,
                  color: "#e0e8f6"
                }
              },
              y: {
                title: { display: true, text: "アンプリチュード", font: { size: 15 } },
                ticks: {
                  font: { size: 13 },
                  callback: function(value) {
                    return value.toExponential ? value.toExponential(2) : value;
                  }
                },
                grid: {
                  display: true,
                  color: "#e0e8f6"
                }
              }
            },
            responsive: false,
            maintainAspectRatio: false
          }
        });

        // 両方式表示
        function genResultHTML(label, peaks, validPpis, meanPPI, stdPPI, colorName) {
          let html = `<div class="result-method"><h2>${label}（ピーク点: <span style="color:${colorName}">●</span>）</h2>`;
          if (validPpis.length === 0) {
            html += "<div class='error'>PPIが検出できませんでした。</div></div>";
          } else {
            html += "<table><thead><tr><th>ピーク位置<br><small>(peak_index)</small></th><th>PPI（秒）</th></tr></thead><tbody>";
            for (let i = 1; i < peaks.length; i++) {
              const ppi = (peaks[i] - peaks[i-1]) / fs;
              if (ppi > 0.35 && ppi < 2.5)
                html += `<tr><td>${peaks[i]}</td><td>${ppi.toFixed(3)}</td></tr>`;
            }
            html += "</tbody></table>";
            html += `<div class="summary">平均PPI：<span style="font-size:1.15em;">${ meanPPI.toFixed(3)} 秒</span><br>
                     PPI標準偏差：<span style="font-size:1.08em;">${ stdPPI.toFixed(3)} 秒</span></div></div>`;
          }
          return html;
        }
        let html = "";
        html += genResultHTML("第一候補（minDistance重視・運動後向け）", peaksA, validPpisA, meanPPIA, stdPPIA, "red");
        html += genResultHTML("第二候補（prominence重視・運動前向け）", peaksB, validPpisB, meanPPIB, stdPPIB, "limegreen");
        output.innerHTML = html;
      };
      reader.readAsArrayBuffer(file);
    });
  </script>
</body>
</html>